import{c4 as Ae,c as de,r as i,aI as n,a5 as p,u as k,P as r,a3 as _,bb as a,d as t,bE as c,bD as ee,a6 as o,M as Y,ac as d,a4 as v,F as ce,aO as me,aL as Ne,aJ as Me}from"./index.5192b47d.js";import{Q as le}from"./QBtnGroup.36130253.js";import{Q as M}from"./QInput.f996048c.js";import{Q as Ie,c as te,d as Q,e as _e,f as ae}from"./QCardActions.d1bd62b7.js";import{a as G,Q as T}from"./QBadge.8bb7b2b0.js";import{Q as se}from"./QSeparator.fc49f0b5.js";import{p as fe,n as pe,o as q}from"./rtl.419f8a93.js";import{Q as B,a as J}from"./QCard.aa6ef5ea.js";import{a as Le}from"./use-quasar.d74d3fec.js";import{a as Ue,u as oe}from"./index.47b11a40.js";import{u as ze}from"./sale-store.5ee75d48.js";import{u as Te}from"./product-store.0adde8a4.js";import{u as Ee}from"./payment-mode-store.37c465bb.js";import{u as Fe}from"./auth-store.4ab610d9.js";import{e as He}from"./receipt.a2190c3f.js";import"./use-dark.9cdcb1d0.js";import"./module_calls.ce394ca6.js";import"./helpers.838b61bb.js";import"./print.15699711.js";import"./_commonjsHelpers.6150b38b.js";const V=E=>(Ne("data-v-58efdbb8"),E=E(),Me(),E),Oe={class:"q-pa-md"},Ke={key:0},Ye={key:1},Ge={class:"q-pa-xs col-xs-12 col-sm-6 col-md-4"},Je={key:1,class:"text-center"},Re={class:"text-center"},je=V(()=>o("br",null,null,-1)),We=V(()=>o("br",null,null,-1)),Xe=V(()=>o("br",null,null,-1)),Ze={key:0},el=V(()=>o("br",null,null,-1)),ll={key:1},tl={key:2},al=V(()=>o("hr",null,null,-1)),sl=V(()=>o("b",null,"Add Product",-1)),ol={key:0},ul=V(()=>o("hr",null,null,-1)),nl={class:"text-center error_msg"},rl=V(()=>o("div",{class:"text-h6"},"Make Payment",-1)),il={class:"q-mt-sm"},dl={key:2,class:"q-pa-sm"},cl={class:"row q-col-gutter-sm"},ml={key:3,class:"q-pa-sm"},_l={class:"text-center error_msg"},fl={border:"1",style:{width:"100%","border-collapse":"collapse"}},pl=V(()=>o("tr",null,[o("th",{class:"text-center q-pa-sm"},"Amount Paid"),o("th",{class:"text-center q-pa-sm"},"Balance"),o("th",{class:"text-center q-pa-sm"},"Mode"),o("th",{class:"text-center q-pa-sm"},"Cleared By"),o("th",{class:"text-center q-pa-sm"},"Cleared On")],-1)),vl={class:"text-center q-pa-sm"},bl={class:"text-center q-pa-sm"},yl={class:"text-center q-pa-sm"},gl={class:"text-center q-pa-sm"},hl={class:"text-center q-pa-sm"},wl={__name:"Bills",setup(E){const I=Ue(),ve=Le(),$=Fe();de(()=>{var s,l;(l=(s=$==null?void 0:$.user)==null?void 0:s.user)==null||l.roles.some(e=>e.name==="Admin"||e.name==="Cashier")});const R=i(""),L=ze(),be=Te(),ye=Ee(),P=i(!1),m=i(!1),F=i(!1),D=i(""),U=i(!0),z=i(!1),C=i(1),A=i(1),j=i(1),W=i(1),H=i(""),g=i(""),f=i(""),b=i(""),x=i(""),N=i([]),O=i([]),{data:ue,isLoading:ge,isError:ne}=oe("bills",()=>L.fetchBills(),{onSuccess:s=>{O.value=s.map(l=>({user:l.user,uuid:l.uuid,bill_ref:l.bill_ref,debtor_name:l.debtor_name,total_debt_paid:l.total_debt_paid,debt_records:l.debt_records,status:l.status,payment_mode:l.payment_mode,selling_price:l.selling_price,actual_selling_price:l.actual_selling_price,created_at:l.created_at,sales:l.sales}))}});oe("products",()=>be.fetchProducts(),{onSuccess:s=>{N.value=s.map(l=>({uuid:l.uuid,name:l.name,price:l.selling_price,category:l.category,department:l.department,quantity:l.quantity}))}});const{data:he}=oe("payment_modes",()=>ye.fetchPaymentModes()),X=i(N.value),we=s=>{g.value=s,P.value=!0},ke=s=>{D.value=s,F.value=!0},qe=()=>{D.value="",F.value=!1},K=de(()=>{let s=0;return g.value.sales.forEach(l=>{s+=l.selling_price*l.quantity}),s}),Ce=s=>{g.value=s,z.value=!0},xe=()=>{x.value="",P.value=!1,f.value="",C.value=1,x.value=""},Ve=async()=>{if(m.value=!0,C.value>f.value.quantity)x.value=`${C.value} is more than the maximum available quantity`,h(`${C.value} is more than the maximum available quantity`,"red","top");else{const s=await L.addProductToBill({bill_uuid:g.value.uuid,uuid:f.value.uuid,name:f.value.name,selling_price:f.value.price,quantity:C.value,product_uuid:f.value.uuid});s.status=="success"?(I.refetchQueries("bills"),g.value="",P.value=!1,m.value=!1,h(s.message,"green","top")):(m.value=!1,g.value="",P.value=!1,h(s.message,"red","top"))}},Pe=()=>{z.value=!1,b.value="",x.value=""},Se=async s=>{if(m.value=!0,confirm("Are you sure?")){const e=await L.removeProductFromBill({product_uuid:s.uuid,product_name:s.name,quantity:s.quantity});e.status=="success"?(I.refetchQueries("bills"),m.value=!1,h(e.message,"green","top")):(g.value="",m.value=!1,P.value=!1,h(e.message,"red","top"))}},Qe=async s=>{if(m.value=!0,confirm("Are you sure?")){const e=await L.deleteBill({bill_uuid:s.uuid});e.status=="success"?(I.refetchQueries("bills"),m.value=!1,h(e.message,"green","top")):(m.value=!1,g.value="",P.value=!1,h(e.message,"red","top"))}},Be=async()=>{console.log("Test ok"),m.value=!0;let s=[];g.value.sales.forEach(e=>s.push({name:e.name,quantity:e.quantity,uuid:e.uuid}));const l={bill_uuid:g.value.uuid,products:s,payment_mode_uuid:b.value.uuid,bill_status:"sold",debtor_name:H.value.trim()};if(b.value.name==="Mpesa & Cash"){const e=Number(j.value)+Number(W.value);l.selling_price=e,l.actual_selling_price=e}else U.value?(l.selling_price=Number(K.value),l.actual_selling_price=Number(K.value)):(l.selling_price=Number(K.value),l.actual_selling_price=Number(A.value));if(l.actual_selling_price&&l.payment_mode_uuid)if(b.value.name==="Debt"&&!H.value)alert("Debtor name is required."),x.value="Debtor name is required.",m.value=!1;else{const e=await L.updateSaleOperation(l);e.status==="success"?(I.refetchQueries("bills"),b.value="",C.value="",z.value=!1,m.value=!1,h(e.message,"green","top")):(x.value=e.message,h(e.message,"red","top-right"))}else m.value=!1,x.value="Name is required!",h("Name is required!","red","top-right")},$e=(s,l)=>{s.length>0&&(N.value.includes(s)||N.value.push(s),l(s,"toggle"))},De=(s,l)=>{l(()=>{if(s==="")X.value=N.value;else{const e=s.toLowerCase();X.value=N.value.filter(u=>u.name.toLowerCase().indexOf(e)>-1)}})},re=s=>{const l=[];s.sales.forEach(u=>{l.push({name:u.name,quantity:u.quantity,price:u.selling_price,total:u.quantity*u.selling_price})});const e={title:"Sales Receipt",status:s.status==="sold"?"Sold":"Pending Payment",user:s.user,payment_mode:s.payment_mode};He(l,["name","quantity","price","total"],e)},h=(s,l,e)=>{ve.notify({message:s,color:l,position:e})};return(s,l)=>(n(),p("div",Oe,[k(ge)?(n(),p("div",Ke,"Loading bills...")):k(ne)?(n(),p("div",Ye,"An error has occurred: "+r(k(ne)),1)):(n(),_(Ie,{key:2,grid:"",flat:"",bordered:"",title:"Sold/Pending Bills",rows:O.value,"row-key":"bill_ref",filter:R.value},{"top-right":a(()=>[t(le,{class:"q-mr-sm q-mb-sm"},{default:a(()=>[t(c,{icon:"list",size:"sm",color:"primary",label:"All Bills",onClick:l[0]||(l[0]=()=>k(I).refetchQueries("bills"))}),t(c,{icon:"timeline",size:"sm",color:"blue",label:"Sold Bills",onClick:l[1]||(l[1]=e=>{var u;return O.value=(u=k(ue))==null?void 0:u.filter(y=>y.status==="sold")})}),t(c,{icon:"pan_tool",size:"sm",color:"brown",label:"Pending Bills",onClick:l[2]||(l[2]=e=>{var u;return O.value=(u=k(ue))==null?void 0:u.filter(y=>y.status==="pending")})}),t(c,{icon:"pan_tool",size:"sm",color:"orange",label:"Clear Bills",to:"/clear_bills"})]),_:1}),t(M,{dense:"",debounce:"300",outlined:"",modelValue:R.value,"onUpdate:modelValue":l[3]||(l[3]=e=>R.value=e),placeholder:"Search"},{append:a(()=>[t(ee,{name:"search"})]),_:1},8,["modelValue"])]),item:a(e=>[o("div",Ge,[t(J,{bordered:"",class:Y(`${e.row.status=="pending"?"sale_pending":""}`)},{default:a(()=>[o("div",{class:Y(["text-center q-pa-xs",`${e.row.payment_mode==="Debt"?"debt_bill":"bill"}`])},[o("small",null,[o("strong",null,[t(ee,{name:"description",style:{"margin-bottom":"2px"}}),d(" BILL-"+r(e.row.bill_ref),1)])])],2),t(B,{style:{padding:"2px"}},{default:a(()=>[e.row.status==="pending"?(n(),_(G,{key:0},{default:a(()=>[o("strong",null," Created by : "+r(e.row.user),1),t(Q),t(le,{flat:""},{default:a(()=>{var u,y,S;return[t(c,{outline:"",rounded:"",size:"sm",color:"blue",icon:"add",onClick:w=>we(e.row)},null,8,["onClick"]),(S=(y=(u=k($))==null?void 0:u.user)==null?void 0:y.user)!=null&&S.roles.some(w=>w.name==="Admin"||w.name==="Cashier")?(n(),_(c,{key:0,size:"sm",outline:"",rounded:"",color:"red",icon:"delete",onClick:w=>Qe(e.row),loading:m.value},null,8,["onClick","loading"])):v("",!0)]}),_:2},1024)]),_:2},1024)):(n(),p("div",Je,[o("strong",null," Created by : "+r(e.row.user),1),t(Q)])),t(se,{class:"q-mb-sm"}),o("div",Re,[o("small",null,"Created On : "+r(e.row.created_at),1),d(),je,o("small",null,[e.row.payment_mode==="Debt"?(n(),_(T,{key:0,color:"blue"},{default:a(()=>[d("Status : "+r(e.row.status)+" ",1),We,d(" Mode : "+r(e.row.payment_mode),1)]),_:2},1024)):(n(),_(T,{key:1,color:`${e.row.status=="pending"?"red":""}`},{default:a(()=>[d("Status : "+r(e.row.status)+" ",1),Xe,d(" Mode : "+r(e.row.payment_mode),1)]),_:2},1032,["color"]))])]),t(se,{class:"q-mb-sm"}),o("small",null,[t(fe,{dense:"",bordered:"",separator:"",class:Y(`${e.row.payment_mode==="Debt"?"debt_bill":"bill"}`)},{default:a(()=>[t(pe,null,{default:a(()=>{var u,y,S;return[t(q,null,{default:a(()=>[d("Name")]),_:1}),t(q,null,{default:a(()=>[d("Price")]),_:1}),t(q,{style:{color:"white"}},{default:a(()=>[d("Quantity")]),_:1}),t(q,{style:{color:"white"}},{default:a(()=>[d("Total")]),_:1}),((S=(y=(u=k($))==null?void 0:u.user)==null?void 0:y.user)==null?void 0:S.roles.some(w=>w.name==="Admin"||w.name==="Cashier"))&&e.row.status==="pending"&&e.row.sales.length>1?(n(),_(q,{key:0},{default:a(()=>[d("Action")]),_:1})):v("",!0)]}),_:2},1024)]),_:2},1032,["class"])]),o("small",null,[t(fe,{dense:"",bordered:"",separator:""},{default:a(()=>[(n(!0),p(ce,null,me(e.row.sales,(u,y)=>(n(),_(pe,{key:y},{default:a(()=>{var S,w,ie;return[t(q,null,{default:a(()=>[d(r(u.name),1)]),_:2},1024),t(q,null,{default:a(()=>[d(r(u.selling_price),1)]),_:2},1024),t(q,null,{default:a(()=>[d(r(u.quantity),1)]),_:2},1024),t(q,null,{default:a(()=>[d(r((u.quantity*u.selling_price).toFixed(2)),1)]),_:2},1024),((ie=(w=(S=k($))==null?void 0:S.user)==null?void 0:w.user)==null?void 0:ie.roles.some(Z=>Z.name==="Admin"||Z.name==="Cashier"))&&e.row.status==="pending"&&e.row.sales.length>1?(n(),_(q,{key:0},{default:a(()=>[t(ee,{name:"delete",color:"red",onClick:Z=>Se(u),style:{cursor:"pointer"}},null,8,["onClick"])]),_:2},1024)):v("",!0)]}),_:2},1024))),128))]),_:2},1024)])]),_:2},1024),t(se),e.row.selling_price>0?(n(),_(B,{key:0,class:"text-center"},{default:a(()=>{var u;return[e.row.payment_mode==="Debt"?(n(),p("p",Ze,[d(" Debtor: "+r(e.row.debtor_name)+" ",1),el,o("b",null,"Amount due Ksh "+r(e.row.selling_price),1)])):(n(),p("b",ll,"Price Ksh "+r(e.row.selling_price),1)),((u=e.row.debt_records)==null?void 0:u.length)>0?(n(),p("p",tl,[t(c,{flat:"",size:"sm",label:"Click to View Payment History",color:"orange",onClick:y=>ke(e.row)},null,8,["onClick"])])):v("",!0),al]}),_:2},1024)):v("",!0),t(B,{style:{padding:"0"}},{default:a(()=>[e.row.status==="sold"?(n(),_(c,{key:0,class:"full-width",dense:"",flat:"",onClick:u=>re(e.row),label:"Print Bill",icon:"print",color:`${e.row.payment_mode==="Debt"?"blue":"primary"}`},null,8,["onClick","color"])):(n(),_(le,{key:1,class:"full-width"},{default:a(()=>[t(c,{class:"full-width",dense:"",flat:"",onClick:u=>re(e.row),label:"Print Bill",icon:"print",color:"primary"},null,8,["onClick"]),t(c,{dense:"",flat:"",push:"",color:"orange",class:"full-width",label:"Sale",icon:"grain",onClick:u=>Ce(e.row)},null,8,["onClick"])]),_:2},1024))]),_:2},1024)]),_:2},1032,["class"])])]),_:1},8,["rows","filter"])),t(te,{modelValue:P.value,"onUpdate:modelValue":l[6]||(l[6]=e=>P.value=e),persistent:""},{default:a(()=>[t(J,{style:{width:"500px"}},{default:a(()=>[t(B,null,{default:a(()=>[t(G,null,{default:a(()=>[sl,t(Q),f.value?(n(),p("small",ol,[t(T,{class:"q-mr-sm",color:"blue"},{default:a(()=>[d("Price: "+r(f.value.price),1)]),_:1}),t(T,{class:"q-mr-sm",color:"blue"},{default:a(()=>[d("Category: "+r(f.value.category),1)]),_:1}),t(T,{class:"q-mr-sm",color:"blue"},{default:a(()=>[d("Department: "+r(f.value.department),1)]),_:1})])):v("",!0)]),_:1}),ul,t(_e,{dense:"","use-input":"",outlined:"",modelValue:f.value,"onUpdate:modelValue":l[4]||(l[4]=e=>f.value=e),"input-debounce":"0",onNewValue:$e,options:X.value,onFilter:De,"option-value":"uuid","option-label":"name",label:"Select Product to add",hint:"You can type in the product name for quick search..."},null,8,["modelValue","options"])]),_:1}),t(B,{class:"q-pt-none"},{default:a(()=>[f.value?(n(),_(M,{key:0,outlined:"",dense:"",label:"Product Quantity",modelValue:C.value,"onUpdate:modelValue":l[5]||(l[5]=e=>C.value=e),type:"number",hint:`Note : You can sale a maximum of ${f.value.quantity}`},null,8,["modelValue","hint"])):v("",!0)]),_:1}),o("div",nl,[o("small",null,r(x.value),1)]),t(ae,{align:"right"},{default:a(()=>[t(c,{flat:"",label:"Cancel",color:"red",onClick:xe}),t(Q),C.value&&f.value?(n(),_(c,{key:0,flat:"",label:"Add Product",color:"primary",onClick:Ve,loading:m.value},null,8,["loading"])):v("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(te,{modelValue:z.value,"onUpdate:modelValue":l[13]||(l[13]=e=>z.value=e),persistent:""},{default:a(()=>[t(J,{style:{width:"500px"}},{default:a(()=>[t(G,null,{default:a(()=>[rl,t(Q),o("small",il,[t(c,{disabled:b.value.name==="Mpesa & Cash",size:"sm",color:"blue",depressed:"",class:Y(`${U.value?"":"actual_selling_price"}`),onClick:l[7]||(l[7]=e=>U.value=!U.value),label:`Expected Selling Price : ${K.value}`},null,8,["disabled","class","label"])])]),_:1}),t(B,{class:"q-pt-none"},{default:a(()=>[!U.value&&b.value.name!=="Mpesa & Cash"?(n(),_(M,{key:0,autofocus:"",outlined:"",dense:"",label:"Actual Selling Price",modelValue:A.value,"onUpdate:modelValue":l[8]||(l[8]=e=>A.value=e),class:"q-pa-xs col-xs-12 col-sm-6 col-md-6 q-mb-sm",type:"number"},null,8,["modelValue"])):v("",!0),A.value&&A.value>0?(n(),_(_e,{key:1,dense:"",outlined:"",modelValue:b.value,"onUpdate:modelValue":l[9]||(l[9]=e=>b.value=e),options:k(he).filter(e=>e.name!=="Debt"),"option-value":"uuid","option-label":"name",label:"Select Payment Mode"},null,8,["modelValue","options"])):v("",!0),b.value.name==="Mpesa & Cash"?(n(),p("div",dl,[o("div",cl,[t(M,{outlined:"",dense:"",class:"col-6",label:"Mpesa Amount",type:"number",modelValue:j.value,"onUpdate:modelValue":l[10]||(l[10]=e=>j.value=e)},null,8,["modelValue"]),t(M,{outlined:"",dense:"",class:"col-6",label:"Cash Amount",type:"number",modelValue:W.value,"onUpdate:modelValue":l[11]||(l[11]=e=>W.value=e)},null,8,["modelValue"])])])):v("",!0),b.value.name==="Debt"?(n(),p("div",ml,[t(M,{outlined:"",modelValue:H.value,"onUpdate:modelValue":l[12]||(l[12]=e=>H.value=e),dense:"",label:"Debtor Name"},null,8,["modelValue"])])):v("",!0)]),_:1}),o("div",_l,[o("small",null,r(x.value),1)]),t(ae,{align:"right"},{default:a(()=>[t(c,{flat:"",label:"Cancel",color:"red",onClick:Pe}),t(Q),A.value&&b.value?(n(),_(c,{key:0,flat:"",label:"Sale",color:"primary",onClick:Be,loading:m.value},null,8,["loading"])):v("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(te,{modelValue:F.value,"onUpdate:modelValue":l[15]||(l[15]=e=>F.value=e),persistent:""},{default:a(()=>[t(J,null,{default:a(()=>[t(G,{class:"bg-orange text-white q-mb-sm"},{default:a(()=>[o("b",null,"Payment History for BILL-"+r(D.value.bill_ref)+". ",1),t(Q),o("b",null,"Name: "+r(D.value.debtor_name)+". ",1)]),_:1}),t(B,{class:"q-pt-none"},{default:a(()=>[o("small",null,[o("table",fl,[pl,(n(!0),p(ce,null,me(D.value.debt_records,e=>(n(),p("tr",{key:e.uuid},[o("td",vl,r(e.amount_paid),1),o("td",bl,r(e.balance),1),o("td",yl,r(e.payment_mode),1),o("td",gl,r(e.user),1),o("td",hl,r(e.created_at),1)]))),128))])])]),_:1}),t(ae,null,{default:a(()=>[t(c,{dense:"",flat:"",label:`Total Paid: ${D.value.total_debt_paid}`,color:"primary",disabled:""},null,8,["label"]),t(Q),t(c,{dense:"",outline:"",label:"Close History",color:"primary",onClick:l[14]||(l[14]=e=>qe())})]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}};var Fl=Ae(wl,[["__scopeId","data-v-58efdbb8"]]);export{Fl as default};
